# Filebeat Configuration for Glassdome
# 
# This configuration ships Glassdome logs to Elasticsearch/ELK.
# 
# Installation:
#   1. Install Filebeat: https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-installation.html
#   2. Copy this file to /etc/filebeat/filebeat.yml
#   3. Update the output.elasticsearch hosts
#   4. Start Filebeat: systemctl start filebeat
#
# Author: Brett Turner (ntounix)
# Created: November 2025

# ================================ Inputs =====================================

filebeat.inputs:

  # JSON logs (primary - structured for SIEM)
  - type: log
    id: glassdome-json
    enabled: true
    paths:
      - /opt/glassdome/logs/glassdome.json
      - /home/*/glassdome/logs/glassdome.json
    
    # Parse JSON logs
    json.keys_under_root: true
    json.add_error_key: true
    json.message_key: message
    
    # Add fields
    fields:
      application: glassdome
      log_type: json
    fields_under_root: true
    
    # Multiline for stack traces (if needed)
    multiline.type: pattern
    multiline.pattern: '^\{'
    multiline.negate: true
    multiline.match: after

  # Plain text logs (backup)
  - type: log
    id: glassdome-text
    enabled: true
    paths:
      - /opt/glassdome/logs/glassdome.log
      - /home/*/glassdome/logs/glassdome.log
    
    fields:
      application: glassdome
      log_type: text
    fields_under_root: true
    
    # Multiline for Python tracebacks
    multiline.type: pattern
    multiline.pattern: '^\d{4}-\d{2}-\d{2}'
    multiline.negate: true
    multiline.match: after

# ================================ Processors =================================

processors:
  # Add host metadata
  - add_host_metadata:
      when.not.contains.tags: forwarded
  
  # Add cloud metadata (if running in cloud)
  - add_cloud_metadata: ~
  
  # Parse timestamp
  - timestamp:
      field: timestamp
      layouts:
        - '2006-01-02T15:04:05.000Z'
        - '2006-01-02T15:04:05Z'
      test:
        - '2025-11-30T15:30:45.123Z'
  
  # Drop debug logs in production (optional)
  # - drop_event:
  #     when:
  #       equals:
  #         level: DEBUG

# ================================ Outputs ====================================

# ---------------------------- Elasticsearch Output ---------------------------
output.elasticsearch:
  # Array of hosts to connect to
  hosts: ["localhost:9200"]
  
  # Protocol - http or https
  protocol: "http"
  
  # Authentication credentials
  # username: "elastic"
  # password: "changeme"
  
  # Index name
  index: "glassdome-%{+yyyy.MM.dd}"
  
  # Pipeline for additional processing
  # pipeline: "glassdome-pipeline"

# ---------------------------- Logstash Output --------------------------------
# Uncomment to send to Logstash instead of Elasticsearch directly
# output.logstash:
#   hosts: ["localhost:5044"]

# ================================ Logging ====================================

logging.level: info
logging.to_files: true
logging.files:
  path: /var/log/filebeat
  name: filebeat
  keepfiles: 7
  permissions: 0644

# ================================ Index Templates ============================

setup.template.settings:
  index.number_of_shards: 1
  index.codec: best_compression

setup.ilm.enabled: auto
setup.ilm.rollover_alias: "glassdome"
setup.ilm.pattern: "{now/d}-000001"

# ================================ Kibana =====================================

# Starting with Beats version 6.0.0, the dashboards are loaded via the Kibana API.
# setup.kibana:
#   host: "localhost:5601"
