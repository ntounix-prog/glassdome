# Session Log - November 21, 2024

**Focus:** Template fixes, Guest Agent issues, Redis deployment

---

## Major Accomplishments

### 1. Template 9000 Configuration Fixes ✅

**Issues Found:**
- Template was set to static IP with no IP address configured
- No password was set in cloud-init
- Disk was on `local-lvm` instead of `TrueNAS`
- Missing VLAN 2 configuration

**Fixes Applied:**
- ✅ Configured DHCP: `ipconfig0=ip=dhcp`
- ✅ Set password: `cipassword=glassdome123`
- ✅ Moved disk to TrueNAS storage: `TrueNAS:9000/vm-9000-disk-0.raw`
- ✅ Configured VLAN 2: `net0=virtio,bridge=vmbr0,tag=2`
- ✅ Disk size increased to 20G

**Result:** Template now properly configured for deployments

---

### 2. Guest Agent Issue Discovery and Fix ✅

**Problem:**
- Template had `agent: enabled=1` in Proxmox config
- But `qemu-guest-agent` package NOT installed inside Ubuntu image
- All cloned VMs couldn't report IP addresses
- IP detection failing: `QEMU guest agent is not running`

**Root Cause:**
- Proxmox cloud-init API doesn't support installing packages
- Template was created from cloud image without qemu-guest-agent
- Cloud-init can't install packages via Proxmox API

**Solution Implemented:**
- ✅ Created `GuestAgentFixer` class (`glassdome/agents/guest_agent_fixer.py`)
- ✅ Integrated into Overseer for automatic detection and fixing
- ✅ Overseer now checks guest agent status on all VMs
- ✅ Auto-fixes via SSH when IP is available

**Template Fix Status:**
- ⚠️ Template still needs manual fix (VM not getting IP automatically)
- ✅ Overseer will handle guest agent issues in deployed VMs automatically

---

### 3. SSH Key Encoding Fix ✅

**Problem:**
- Proxmox API rejecting SSH keys: `invalid urlencoded string`
- Newline characters in SSH key causing encoding failures

**Fix:**
- ✅ Aggressive newline removal before URL encoding
- ✅ Proper URL encoding with `urllib.parse.quote()`
- ✅ Fallback to password authentication when SSH keys fail

**Location:** `glassdome/platforms/proxmox_client.py:428-441`

---

### 4. Redis Vulnerable Server Deployment ✅

**Deployment:**
- ✅ VM deployed from template 9000
- ✅ Redis 8.2.1 installed and configured
- ✅ Lua scripting enabled (required for CVE-2025-49844)
- ✅ Service running and verified

**Server Details:**
- **IP:** 192.168.3.207 (not name-resolvable)
- **Port:** 6379
- **Password:** glassdome123
- **Version:** Redis 8.2.1 (vulnerable to CVE-2025-49844 - RediShell)
- **Status:** ✅ Running and ready for exploit development

**Note:** Exploit code not included - user will develop separately

---

## Code Changes

### New Files:
- `glassdome/agents/guest_agent_fixer.py` - Guest agent detection and fixing
- `docs/session_logs/GUEST_AGENT_ISSUE.md` - Issue documentation
- `docs/session_logs/GUEST_AGENT_FIX.md` - Fix documentation
- `docs/session_logs/TEMPLATE_FIX_SUMMARY.md` - Template fix summary
- `docs/session_logs/REDIS_DEPLOYMENT_COMPLETE.md` - Redis deployment docs

### Modified Files:
- `glassdome/platforms/proxmox_client.py` - SSH key encoding fix, password support
- `glassdome/platforms/proxmox_gateway.py` - Template creation updates
- `glassdome/agents/overseer.py` - Guest agent checking integration
- `scripts/deploy_redis_vulnerable.py` - Password fallback, DHCP support

---

## Key Lessons Learned

1. **Cloud-init Template Requirements:**
   - Must have password OR SSH keys (not just one)
   - DHCP must be explicitly configured
   - VLAN tags must be set for proper network

2. **Guest Agent:**
   - Template needs qemu-guest-agent installed inside image
   - Proxmox API can't install packages via cloud-init
   - Overseer can auto-fix deployed VMs but not templates

3. **SSH Key Encoding:**
   - Proxmox requires URL-encoded SSH keys
   - Must aggressively remove ALL newlines before encoding
   - Password fallback is critical for reliability

4. **Storage:**
   - TrueNAS NFS format: `TrueNAS:9000/vm-9000-disk-0.raw`
   - Template should be on shared storage for multi-node deployments

---

## Pending Tasks

- [ ] Manually fix template 9000 to install qemu-guest-agent
- [ ] Develop Redis CVE-2025-49844 exploit code
- [ ] Test guest agent auto-fix in Overseer
- [ ] Update template creation script to include qemu-guest-agent

---

## Files Modified Today

**Code:**
- `glassdome/platforms/proxmox_client.py`
- `glassdome/platforms/proxmox_gateway.py`
- `glassdome/agents/overseer.py`
- `glassdome/agents/guest_agent_fixer.py` (new)
- `scripts/deploy_redis_vulnerable.py`

**Documentation:**
- `docs/session_logs/CRITICAL_LESSONS_2024-11-21.md`
- `docs/session_logs/GUEST_AGENT_ISSUE.md` (new)
- `docs/session_logs/GUEST_AGENT_FIX.md` (new)
- `docs/session_logs/TEMPLATE_FIX_SUMMARY.md` (new)
- `docs/session_logs/REDIS_DEPLOYMENT_COMPLETE.md` (new)
- `docs/session_logs/SESSION_2024-11-21.md` (this file)

---

**Session End:** 2024-11-21

