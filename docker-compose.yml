version: '3.8'

# Glassdome Container Fleet
# =========================
# Always-on orchestrators ready to deploy labs, inject vulns, validate, monitor
# Logs shipped to ELK stack at 192.168.3.26

# Common logging environment variables (ELK Stack at 192.168.3.26)
x-logging-env: &logging-env
  LOGSTASH_ENABLED: ${LOGSTASH_ENABLED:-true}
  LOGSTASH_HOST: ${LOGSTASH_HOST:-192.168.3.26}
  LOGSTASH_PORT: ${LOGSTASH_PORT:-5045}
  LOG_LEVEL: ${LOG_LEVEL:-INFO}
  LOG_JSON_ENABLED: "true"

# Common reaper environment
x-reaper-env: &reaper-env
  REDIS_URL: redis://redis:6379/0
  DATABASE_URL: ${DATABASE_URL}
  GLASSDOME_MODE: reaper
  LOGSTASH_ENABLED: ${LOGSTASH_ENABLED:-true}
  LOGSTASH_HOST: ${LOGSTASH_HOST:-192.168.3.26}
  LOGSTASH_PORT: ${LOGSTASH_PORT:-5045}
  LOG_LEVEL: ${LOG_LEVEL:-INFO}
  LOG_JSON_ENABLED: "true"

# Common whiteknight environment
x-whiteknight-env: &whiteknight-env
  REDIS_URL: redis://redis:6379/0
  DATABASE_URL: ${DATABASE_URL}
  GLASSDOME_MODE: whiteknight
  LOGSTASH_ENABLED: ${LOGSTASH_ENABLED:-true}
  LOGSTASH_HOST: ${LOGSTASH_HOST:-192.168.3.26}
  LOGSTASH_PORT: ${LOGSTASH_PORT:-5045}
  LOG_LEVEL: ${LOG_LEVEL:-INFO}
  LOG_JSON_ENABLED: "true"

# Common whitepawn environment
x-whitepawn-env: &whitepawn-env
  REDIS_URL: redis://redis:6379/0
  DATABASE_URL: ${DATABASE_URL}
  GLASSDOME_MODE: whitepawn
  MONITOR_INTERVAL: 15
  LOGSTASH_ENABLED: ${LOGSTASH_ENABLED:-true}
  LOGSTASH_HOST: ${LOGSTASH_HOST:-192.168.3.26}
  LOGSTASH_PORT: ${LOGSTASH_PORT:-5045}
  LOG_LEVEL: ${LOG_LEVEL:-INFO}
  LOG_JSON_ENABLED: "true"

services:
  # ============================================================================
  # Core Infrastructure
  # ============================================================================
  
  redis:
    image: redis:7-alpine
    container_name: glassdome-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - glassdome-internal

  # ============================================================================
  # Glassdome Backend (API Server)
  # ============================================================================
  
  backend:
    build:
      context: .
      dockerfile: containers/orchestrator/Dockerfile
    container_name: glassdome-backend
    restart: unless-stopped
    environment:
      - REDIS_URL=redis://redis:6379/0
      - DATABASE_URL=${DATABASE_URL}
      - GLASSDOME_MODE=backend
      - PROXMOX_HOST=${PROXMOX_HOST}
      - PROXMOX_USER=${PROXMOX_USER}
      - PROXMOX_PASSWORD=${PROXMOX_PASSWORD}
      # ELK Stack Logging
      - LOGSTASH_ENABLED=${LOGSTASH_ENABLED:-true}
      - LOGSTASH_HOST=${LOGSTASH_HOST:-192.168.3.26}
      - LOGSTASH_PORT=${LOGSTASH_PORT:-5045}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_JSON_ENABLED=true
    ports:
      - "8011:8000"
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ./logs:/app/logs
    networks:
      - glassdome-internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # Orchestrator Workers (Always Running)
  # ============================================================================
  
  # Lab Deployment Orchestrator (concurrency=8 for parallel VM deploys)
  orchestrator:
    build:
      context: .
      dockerfile: containers/orchestrator/Dockerfile
    container_name: glassdome-orchestrator
    restart: unless-stopped
    environment:
      - REDIS_URL=redis://redis:6379/0
      - DATABASE_URL=${DATABASE_URL}
      - GLASSDOME_MODE=orchestrator
      - WORKER_CONCURRENCY=8
      - PROXMOX_HOST=${PROXMOX_HOST}
      - PROXMOX_USER=${PROXMOX_USER}
      - PROXMOX_PASSWORD=${PROXMOX_PASSWORD}
      # ELK Stack Logging
      - LOGSTASH_ENABLED=${LOGSTASH_ENABLED:-true}
      - LOGSTASH_HOST=${LOGSTASH_HOST:-192.168.3.26}
      - LOGSTASH_PORT=${LOGSTASH_PORT:-5045}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_JSON_ENABLED=true
      - WORKER_ID=orchestrator
    depends_on:
      - redis
      - backend
    volumes:
      - ./logs:/app/logs
    networks:
      - glassdome-internal
    cap_add:
      - NET_ADMIN

  # ============================================================================
  # Reaper Workers (Vulnerability Injection) - 8 workers for parallel injection
  # ============================================================================
  
  reaper-1:
    build:
      context: .
      dockerfile: containers/reaper/Dockerfile
    container_name: glassdome-reaper-1
    restart: unless-stopped
    environment:
      <<: *reaper-env
      WORKER_ID: reaper-1
    depends_on:
      - redis
      - orchestrator
    volumes:
      - ./logs:/app/logs
    networks:
      - glassdome-internal
    cap_add:
      - NET_ADMIN

  reaper-2:
    build:
      context: .
      dockerfile: containers/reaper/Dockerfile
    container_name: glassdome-reaper-2
    restart: unless-stopped
    environment:
      <<: *reaper-env
      WORKER_ID: reaper-2
    depends_on:
      - redis
      - orchestrator
    volumes:
      - ./logs:/app/logs
    networks:
      - glassdome-internal
    cap_add:
      - NET_ADMIN

  reaper-3:
    build:
      context: .
      dockerfile: containers/reaper/Dockerfile
    container_name: glassdome-reaper-3
    restart: unless-stopped
    environment:
      <<: *reaper-env
      WORKER_ID: reaper-3
    depends_on:
      - redis
      - orchestrator
    volumes:
      - ./logs:/app/logs
    networks:
      - glassdome-internal
    cap_add:
      - NET_ADMIN

  reaper-4:
    build:
      context: .
      dockerfile: containers/reaper/Dockerfile
    container_name: glassdome-reaper-4
    restart: unless-stopped
    environment:
      <<: *reaper-env
      WORKER_ID: reaper-4
    depends_on:
      - redis
      - orchestrator
    volumes:
      - ./logs:/app/logs
    networks:
      - glassdome-internal
    cap_add:
      - NET_ADMIN

  reaper-5:
    build:
      context: .
      dockerfile: containers/reaper/Dockerfile
    container_name: glassdome-reaper-5
    restart: unless-stopped
    environment:
      <<: *reaper-env
      WORKER_ID: reaper-5
    depends_on:
      - redis
      - orchestrator
    volumes:
      - ./logs:/app/logs
    networks:
      - glassdome-internal
    cap_add:
      - NET_ADMIN

  reaper-6:
    build:
      context: .
      dockerfile: containers/reaper/Dockerfile
    container_name: glassdome-reaper-6
    restart: unless-stopped
    environment:
      <<: *reaper-env
      WORKER_ID: reaper-6
    depends_on:
      - redis
      - orchestrator
    volumes:
      - ./logs:/app/logs
    networks:
      - glassdome-internal
    cap_add:
      - NET_ADMIN

  reaper-7:
    build:
      context: .
      dockerfile: containers/reaper/Dockerfile
    container_name: glassdome-reaper-7
    restart: unless-stopped
    environment:
      <<: *reaper-env
      WORKER_ID: reaper-7
    depends_on:
      - redis
      - orchestrator
    volumes:
      - ./logs:/app/logs
    networks:
      - glassdome-internal
    cap_add:
      - NET_ADMIN

  reaper-8:
    build:
      context: .
      dockerfile: containers/reaper/Dockerfile
    container_name: glassdome-reaper-8
    restart: unless-stopped
    environment:
      <<: *reaper-env
      WORKER_ID: reaper-8
    depends_on:
      - redis
      - orchestrator
    volumes:
      - ./logs:/app/logs
    networks:
      - glassdome-internal
    cap_add:
      - NET_ADMIN

  # ============================================================================
  # WhiteKnight Workers (Vulnerability Validation)
  # ============================================================================
  
  whiteknight-1:
    build:
      context: .
      dockerfile: containers/whiteknight/Dockerfile
    container_name: glassdome-whiteknight-1
    restart: unless-stopped
    environment:
      <<: *whiteknight-env
      WORKER_ID: whiteknight-1
    depends_on:
      - redis
      - orchestrator
    volumes:
      - ./logs:/app/logs
    networks:
      - glassdome-internal
    cap_add:
      - NET_ADMIN

  # ============================================================================
  # WhitePawn Monitors (Continuous Network Monitoring) - 4 monitors
  # ============================================================================
  
  whitepawn-1:
    build:
      context: .
      dockerfile: containers/whitepawn/Dockerfile
    container_name: glassdome-whitepawn-1
    restart: unless-stopped
    environment:
      <<: *whitepawn-env
      WORKER_ID: whitepawn-1
    depends_on:
      - redis
      - orchestrator
    volumes:
      - ./logs:/app/logs
    networks:
      - glassdome-internal
    cap_add:
      - NET_ADMIN

  whitepawn-2:
    build:
      context: .
      dockerfile: containers/whitepawn/Dockerfile
    container_name: glassdome-whitepawn-2
    restart: unless-stopped
    environment:
      <<: *whitepawn-env
      WORKER_ID: whitepawn-2
    depends_on:
      - redis
      - orchestrator
    volumes:
      - ./logs:/app/logs
    networks:
      - glassdome-internal
    cap_add:
      - NET_ADMIN

  whitepawn-3:
    build:
      context: .
      dockerfile: containers/whitepawn/Dockerfile
    container_name: glassdome-whitepawn-3
    restart: unless-stopped
    environment:
      <<: *whitepawn-env
      WORKER_ID: whitepawn-3
    depends_on:
      - redis
      - orchestrator
    volumes:
      - ./logs:/app/logs
    networks:
      - glassdome-internal
    cap_add:
      - NET_ADMIN

  whitepawn-4:
    build:
      context: .
      dockerfile: containers/whitepawn/Dockerfile
    container_name: glassdome-whitepawn-4
    restart: unless-stopped
    environment:
      <<: *whitepawn-env
      WORKER_ID: whitepawn-4
    depends_on:
      - redis
      - orchestrator
    volumes:
      - ./logs:/app/logs
    networks:
      - glassdome-internal
    cap_add:
      - NET_ADMIN

  # ============================================================================
  # Filebeat - Log Shipper (ships logs to ELK stack)
  # ============================================================================
  
  filebeat:
    image: docker.elastic.co/beats/filebeat:8.11.3
    container_name: glassdome-filebeat
    user: root
    restart: unless-stopped
    environment:
      - ELASTICSEARCH_HOSTS=192.168.3.26:9200
      - LOGSTASH_HOSTS=192.168.3.26:5044
      - KIBANA_HOST=192.168.3.26:5601
    volumes:
      # Filebeat configuration
      - ./deploy/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      # Glassdome logs
      - ./logs:/app/logs:ro
      # Docker container logs
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - glassdome-internal
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "filebeat", "test", "config"]
      interval: 30s
      timeout: 10s
      retries: 3
    command: ["filebeat", "-e", "-strict.perms=false"]

# ============================================================================
# Networks
# ============================================================================

networks:
  glassdome-internal:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/24

# ============================================================================
# Volumes
# ============================================================================

volumes:
  redis_data:
